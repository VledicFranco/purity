<html><head><title>Purity</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Francisco M. Aramburo Torres" /><meta name="description" content="Easy pure code in Scala" /><meta name="og:image" content="/purity/img/poster.png" /><meta name="og:title" content="Purity" /><meta name="og:site_name" content="Purity" /><meta name="og:url" content="https://francoara.github.io/purity/" /><meta name="og:type" content="website" /><meta name="og:description" content="Easy pure code in Scala" /><link rel="icon" type="image/png" href="/purity/img/favicon.png" /><meta name="twitter:title" content="Purity" /><meta name="twitter:image" content="https://francoara.github.io/purity/img/poster.png" /><meta name="twitter:description" content="Easy pure code in Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/purity/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/purity/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/purity/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/purity/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/purity/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/purity/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/purity/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/purity/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/purity/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/purity/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/purity/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/purity/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/purity/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/purity/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/purity/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/purity/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/purity/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/purity/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/purity/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/purity/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/purity/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/purity/css/style.css" /><link rel="stylesheet" href="/purity/css/palette.css" /><link rel="stylesheet" href="/purity/css/codemirror.css" /><link rel="stylesheet" href="/purity/css/kazari-style.css" /><link rel="stylesheet" href="/purity/css/monokai.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/purity/" class="brand"><div class="brand-wrapper"><span>Purity</span></div></a></li> <li><a href="/purity/datatypes.html" class="">Data Types</a></li> <li><a href="/purity/datatypes/script.html" class=" active ">Script</a> <ul class="sub_section"> <li><a href="/purity/datatypes/script/dependencies.html" class="">Dependencies</a></li> <li><a href="/purity/datatypes/script/failures.html" class="">Failures</a></li> <li><a href="/purity/datatypes/script/errors.html" class="">Effects and Errors</a></li> <li><a href="/purity/datatypes/script/logging.html" class="">Logging</a></li></ul></li>      </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/FrancoAra/purity"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/FrancoAra/purity"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Purity Easy pure code in Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Purity Easy pure code in Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="FrancoAra" data-github-repo="purity"><div class="content-wrapper"><section><h2 id="script">Script</h2>

<p>Script is a monad built from the ground up with the objective of handling the most common basic requirements of a
developers day to day programs. It is designed to be as easy as possible to use. It can be used to address
dependency injection, domain failure handling, low level error handling, IO, and mocking, all of these while being
highly compositional, referential transparent and type safe. Script is not a silver bullet, but hopefully it will be a
useful tool for several of your use cases.</p>

<h3 id="small-overview-of-the-script-type">Small overview of the Script type</h3>

<p>Script is in reality an implementation of <code class="highlighter-rouge">ScriptT[F[_], D, E, A]</code> (a monad transformer) where:</p>

<ul>
  <li><code class="highlighter-rouge">F[_]</code> is a monad that is able to handle IO or asynchronicity (Like Future, IO or Task).</li>
  <li><code class="highlighter-rouge">D</code> represents some dependencies.</li>
  <li><code class="highlighter-rouge">E</code> represents some domain failures.</li>
  <li><code class="highlighter-rouge">A</code> represents a pure value.</li>
</ul>

<p>Also Script accumulates log lines using the <code class="highlighter-rouge">purity.logging.LogLine</code> type.</p>

<p>For ease of use, purity provides an implementation of ScriptT and it’s DSL using <code class="highlighter-rouge">cats.effects.IO</code>. The former
is located at <code class="highlighter-rouge">purity.script.io.Script</code>. Such package contains all of the functions you will need.</p>

<h4 id="a-quick-example-in-code">A quick example in code</h4>

<p>This is the full example that we will use in the next tutorials. Each part will be explained, modified with alternatives,
and improved upon! As well most of the code can be found in the <code class="highlighter-rouge">example</code> project folder within the repository of the
project.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">purity.script.io.</span><span class="o">{</span><span class="nc">Script</span><span class="o">,</span> <span class="n">dependencies</span><span class="o">,</span> <span class="n">find</span><span class="o">,</span> <span class="n">log</span><span class="o">,</span> <span class="n">script</span><span class="o">,</span> <span class="n">scriptE</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">purity.logging.</span><span class="o">{</span><span class="nc">ColorPrint</span><span class="o">,</span> <span class="nc">LogLevel</span><span class="o">,</span> <span class="nc">Logger</span><span class="o">,</span> <span class="nc">LoggerContainer</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">UserAuth0</span> <span class="o">{</span>

  <span class="k">type</span> <span class="kt">UserId</span> <span class="o">=</span> <span class="nc">Int</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Credentials</span><span class="o">(</span><span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">password</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">Response</span><span class="o">(</span><span class="n">code</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">body</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="cm">/** Dependencies */</span>

  <span class="k">trait</span> <span class="nc">DatabaseConfig</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">databaseUri</span><span class="k">:</span> <span class="kt">String</span>
    <span class="k">val</span> <span class="n">databaseUsername</span><span class="k">:</span> <span class="kt">String</span>
    <span class="k">val</span> <span class="n">databasePassword</span><span class="k">:</span> <span class="kt">String</span>
  <span class="o">}</span>

  <span class="k">trait</span> <span class="nc">AuthenticationServiceConfig</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">authServiceUrl</span><span class="k">:</span> <span class="kt">String</span>
    <span class="k">val</span> <span class="n">authServiceToken</span><span class="k">:</span> <span class="kt">String</span>
  <span class="o">}</span>

  <span class="cm">/** Domain Failures */</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">UserNotFound</span><span class="o">(</span><span class="n">email</span><span class="k">:</span> <span class="kt">UserId</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">WrongCredentials</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">)</span>

  <span class="cm">/** IO functions */</span>

  <span class="cm">/** Tries to fetch a user id by using an authentication service.
    *  Note that it requires some configuration for this to happen.
    *  The function returns a cats IO because it needs to access the network in order to use the authentication service.
    */</span>
  <span class="k">def</span> <span class="n">authenticationIO</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">,</span> <span class="n">config</span><span class="k">:</span> <span class="kt">AuthenticationServiceConfig</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">WrongCredentials</span>, <span class="kt">UserId</span><span class="o">]]</span> <span class="k">=</span>
    <span class="c1">// Mock of the actual service call
</span>    <span class="nc">IO</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">Right</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>

  <span class="cm">/** Tries to fetch a user from the database.
    *  Note that it requires some configuration as well.
    *  The function returns also a cats IO because querying the database accesses the network.
    */</span>
  <span class="k">def</span> <span class="n">queryUserIO</span><span class="o">(</span><span class="n">userId</span><span class="k">:</span> <span class="kt">UserId</span><span class="o">,</span> <span class="n">config</span><span class="k">:</span> <span class="kt">DatabaseConfig</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]]</span> <span class="k">=</span>
    <span class="c1">// Mock of the actual query
</span>    <span class="nc">IO</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">User</span><span class="o">(</span><span class="s">"franco@lambda.org"</span><span class="o">,</span> <span class="mi">27</span><span class="o">)))</span>

  <span class="cm">/** Our highly expressive Script programs. */</span>

  <span class="k">type</span> <span class="kt">GetUserConfiguration</span> <span class="o">=</span> <span class="nc">AuthenticationServiceConfig</span> <span class="k">with</span> <span class="nc">DatabaseConfig</span> <span class="k">with</span> <span class="nc">LoggerContainer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>

  <span class="k">type</span> <span class="kt">GetUserFailure</span> <span class="o">=</span> <span class="nc">Either</span><span class="o">[</span><span class="kt">WrongCredentials</span>, <span class="kt">UserNotFound</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">authenticatedUser</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">)</span><span class="k">:</span> <span class="kt">Script</span><span class="o">[</span><span class="kt">GetUserConfiguration</span>, <span class="kt">GetUserFailure</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">userId</span> <span class="k">&lt;-</span> <span class="n">authentication</span><span class="o">(</span><span class="n">credentials</span><span class="o">).</span><span class="n">mapFailure</span><span class="o">(</span><span class="nc">Left</span><span class="o">.</span><span class="n">apply</span><span class="o">)</span>
      <span class="n">user</span> <span class="k">&lt;-</span> <span class="n">queryUser</span><span class="o">(</span><span class="n">userId</span><span class="o">).</span><span class="n">mapFailure</span><span class="o">(</span><span class="nc">Right</span><span class="o">.</span><span class="n">apply</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">user</span>

  <span class="k">def</span> <span class="n">fetchUserAge</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">)</span><span class="k">:</span> <span class="kt">Script</span><span class="o">[</span><span class="kt">GetUserConfiguration</span>, <span class="kt">GetUserFailure</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">authenticatedUser</span><span class="o">(</span><span class="n">credentials</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">authentication</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">)</span><span class="k">:</span> <span class="kt">Script</span><span class="o">[</span><span class="kt">AuthenticationServiceConfig</span> <span class="kt">with</span> <span class="kt">LoggerContainer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>, <span class="kt">WrongCredentials</span>, <span class="kt">UserId</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">config</span> <span class="k">&lt;-</span> <span class="n">dependencies</span><span class="o">[</span><span class="kt">AuthenticationServiceConfig</span><span class="o">]</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Authenticating $credentials using service ${config.authServiceUrl}"</span><span class="o">)</span>
      <span class="n">userId</span> <span class="k">&lt;-</span> <span class="n">scriptE</span><span class="o">(</span><span class="n">authenticationIO</span><span class="o">(</span><span class="n">credentials</span><span class="o">,</span> <span class="n">config</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">userId</span>

  <span class="k">def</span> <span class="n">queryUser</span><span class="o">(</span><span class="n">userId</span><span class="k">:</span> <span class="kt">UserId</span><span class="o">)</span><span class="k">:</span> <span class="kt">Script</span><span class="o">[</span><span class="kt">DatabaseConfig</span> <span class="kt">with</span> <span class="kt">LoggerContainer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>, <span class="kt">UserNotFound</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">config</span> <span class="k">&lt;-</span> <span class="n">dependencies</span><span class="o">[</span><span class="kt">DatabaseConfig</span><span class="o">]</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="o">(</span><span class="n">s</span><span class="s">"Querying for user $userId in database ${config.databaseUri}"</span><span class="o">)</span>
      <span class="n">maybeUser</span> <span class="k">&lt;-</span> <span class="n">script</span><span class="o">(</span><span class="n">queryUserIO</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">config</span><span class="o">))</span>
      <span class="n">user</span> <span class="k">&lt;-</span> <span class="n">find</span><span class="o">(</span><span class="n">maybeUser</span><span class="o">)(</span><span class="nc">UserNotFound</span><span class="o">(</span><span class="n">userId</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">user</span>

  <span class="cm">/** Finally provide the dependencies and success/failure handlers in a function that handles the communication layer
    * (Probably for your http library).
    */</span>
  <span class="k">def</span> <span class="n">ageRequest</span><span class="o">(</span><span class="n">credentials</span><span class="k">:</span> <span class="kt">Credentials</span><span class="o">)</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">fetchUserAge</span><span class="o">(</span><span class="n">credentials</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">failureHandler</span><span class="o">,</span> <span class="n">successHandler</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">config</span><span class="k">:</span> <span class="kt">GetUserConfiguration</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nc">DatabaseConfig</span> <span class="k">with</span> <span class="nc">AuthenticationServiceConfig</span> <span class="k">with</span> <span class="nc">LoggerContainer</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="o">{</span>

      <span class="k">val</span> <span class="n">databaseUri</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"some:uri"</span>
      <span class="k">val</span> <span class="n">databasePassword</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"some-password"</span>
      <span class="k">val</span> <span class="n">databaseUsername</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"root"</span>
      <span class="k">val</span> <span class="n">authServiceUrl</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"auth.service/auth"</span>
      <span class="k">val</span> <span class="n">authServiceToken</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"1234567890"</span>

      <span class="k">val</span> <span class="n">logger</span><span class="k">:</span> <span class="kt">Logger</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nc">ColorPrint</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="nc">AllLevel</span><span class="o">,</span> <span class="n">printSource</span> <span class="k">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">printTime</span> <span class="k">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">failureHandler</span><span class="o">(</span><span class="n">failure</span><span class="k">:</span> <span class="kt">GetUserFailure</span><span class="o">)</span><span class="k">:</span> <span class="kt">Response</span> <span class="o">=</span>
    <span class="n">failure</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Left</span><span class="o">(</span><span class="n">wrongCredentials</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nc">Response</span><span class="o">(</span><span class="mi">400</span><span class="o">,</span> <span class="n">s</span><span class="s">"Authentication with user ${wrongCredentials.credentials.email} failed"</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">Right</span><span class="o">(</span><span class="n">userNotFound</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nc">Response</span><span class="o">(</span><span class="mi">500</span><span class="o">,</span> <span class="n">s</span><span class="s">"Could not find user ${userNotFound.email} in the database"</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">def</span> <span class="n">successHandler</span><span class="o">(</span><span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Response</span> <span class="o">=</span>
    <span class="nc">Response</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">s</span><span class="s">"Here is the age you were looking for! :: $age"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="for-those-familiar-with-monad-transformers">For those familiar with monad transformers:</h4>

<p>One may see Script as a a stack of a <code class="highlighter-rouge">ReaderT</code> (for dependencies) with <code class="highlighter-rouge">WriterT</code>
(for logs) with EitherT (for domain failures) and an <code class="highlighter-rouge">F[_]</code> like <code class="highlighter-rouge">IO</code> or <code class="highlighter-rouge">Future</code> (for IO, async and low level errors).
The differences between this two are:</p>

<p>1) Script provides several functions to add syntax and ease of use of this common stack
2) And most importantly, Script has variance annotations, leveraging Scala’s subtyping system, we will see how this may
become powerful when composing dependencies.</p>

<h3 id="difference-between-domain-failures-and-low-level-errors">Difference between domain failures and low level errors</h3>

<p>Domain failures are supposed to model what can possible go wrong within the “business” domain of the function, lower
level exceptions (like network failure) should be handled within the F[_] that the function <code class="highlighter-rouge">run</code> returns.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/purity/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'FrancoAra/purity'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/purity/js/main.js"></script><script src="/purity/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>